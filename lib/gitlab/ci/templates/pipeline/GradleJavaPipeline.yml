variables:
  STANDARD_GRADLE_FLAGS: '-s --no-daemon -PnoMavenLocal --refresh-dependencies --console=plain'
  GRADLE_TEST_FLAGS: "$STANDARD_GRADLE_FLAGS $EXTRA_GRADLE_TEST_FLAGS"
  INSTALLER_GRADLE_FLAGS: "$GRADLE_FLAGS -Pi4jLicenseKey=${I4J_LICENSE_KEY} -PnoMavenLocal"
  DEV_REGEX: 'develop'
  RELEASE_REGEX: '^[0-9]+\.[0-9]+$|^release\/.+$'
  DEV_OR_RELEASE_REGEX: "$DEV_REGEX|$RELEASE_REGEX"
  DEFAULT_IMAGE: "openjdk:11"
  GITLAB_FEATURES: "$GITLAB_FEATURES|dependency_scanning"

default:
  image: $DEFAULT_IMAGE

include:
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/feature/release-job-improvements/lib/gitlab/ci/templates/references/certs/CertificateOfAuthoritySetup.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/feature/release-job-improvements/lib/gitlab/ci/templates/references/gradle/GradleWrapperSetup.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/feature/release-job-improvements/lib/gitlab/ci/templates/jobs/gradle/Test.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/feature/release-job-improvements/lib/gitlab/ci/templates/jobs/gradle/PublishJar.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

test_java:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

publish_javadocs:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

publish_snapshot_jar:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

publish_release_jar:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

secret_detection:
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
    paths:
      - gl-secret-detection-report.json

secret_detection_validation:
  stage: scan_validation
  script:
    - echo 'Checking for secrets'
    - if grep -q '\"vulnerabilities\"..\[]', gl-secret-detection-report.json; then
        echo 'No secrets detected';
      else
        echo 'Detected secrets in commit! Please view the `gl-secret-detection-report.json artifact for details.' && exit 1;
      fi

dependency_scanning:
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    paths:
      - gl-depedndency-scanning-report.json

dependency_scanning_validation:
  stage: scan_validation
  allow_failure: true
  script:
    - echo 'Checking for critical vulnerabilities'
    - if grep -q '\"severity\"..\"Critical\"', gl-depedndency-scanning-report.json; then
        echo 'No critical vulnerabilities detected';
      else
        echo 'Critical vulnerabilities detected! Please view the gl-secret-detection-report.json artifact for details.' && exit 1;
      fi

stages:
  - test
  - scan_validation
  - publish

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ $DEV_REGEX
    - if: $CI_PIPELINE_SOURCE == "web"