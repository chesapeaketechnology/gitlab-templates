variables:
  SAFE_TEST:
    value: "false"
    options:
      - "true"
      - "false"
    description: "Run a test to check the build pipeline before actually deploying, when set to \"true\"."
  QUALITY_CHECK_DISABLED:
    value: "false"
    options:
      - "true"
      - "false"
    description: "Disable quality scanning and reporting jobs"
  DEPENDENCY_LICENSE_SCANNING_DISABLED:
    value: "false"
    options:
      - "true"
      - "false"
    description: "Disable license scanning and reporting jobs"
  SAST_DISABLED:
    value: "false"
    options:
      - "true"
      - "false"
    description: "Disable static application security testing scanning and reporting jobs"
  MAVEN_DETECTION_DISABLED:
    value: "false"
    options:
      - "true"
      - "false"
    description: "Disable dependency vulnerability scanning and reporting jobs"
  PUBLISH_JAVADOCS_DISABLED:
    value: "false"
    options:
      - "true"
      - "false"
    description: "Disable javadoc publishing jobs"
  FORTIFY_SCANNING_DISABLED:
    value: "true"
    options:
      - "true"
      - "false"
    description: "Disable fortify scanning and reporting jobs"
  TASK_ARGUMENTS:
    value: ""
    description: "Add any additional gradle commands for this build here. ex: \"-Pforce -x updateReleaseVersion\""
  BASE_GRADLE_FLAGS: '-s --no-daemon -PnoMavenLocal --refresh-dependencies --console=plain $TASK_ARGUMENTS'
  STANDARD_GRADLE_FLAGS: "$BASE_GRADLE_FLAGS" #This is modified during workflow rules
  GRADLE_TEST_FLAGS: "$STANDARD_GRADLE_FLAGS $EXTRA_GRADLE_TEST_FLAGS"
  INSTALLER_GRADLE_FLAGS: "$GRADLE_FLAGS -Pi4jLicenseKey=${I4J_LICENSE_KEY} -PnoMavenLocal"
  DEV_OR_RELEASE_REGEX: '^develop$|^v3-develop$|^v2-develop$|^[0-9]+\.[0-9]+$|^release\/.+$'
  IMAGE_PREFIX: ""
  DEFAULT_IMAGE: "openjdk:11"
  GITLAB_FEATURES: "$GITLAB_FEATURES|dependency_scanning"
  QUALITY_CHECK_GRADLE_TASKS: pmdMain violations -x build -x test  

default:
  image: ${IMAGE_PREFIX}$DEFAULT_IMAGE
  interruptible: true
  retry:
    max: 2
    when:
      - runner_system_failure

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/references/certs/CertificateOfAuthoritySetup.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/references/gradle/GradleWrapperSetup.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/Test.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/PublishJar.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/PublishPages.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/SecretDetection.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/QualityReporting.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/DependencyScanning.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/LicenseScanning.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gradle/StaticApplicationSecurityTesting.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/security/FortifyScanning.yml
  - remote: https://raw.githubusercontent.com/chesapeaketechnology/gitlab-templates/experimental/2.0/lib/gitlab/ci/templates/jobs/gitlab_release_traceability_job

test_java:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

pages_generate:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

publish_snapshot_jar:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

publish_release_jar:
  before_script:
    - !reference [ .configure_gradle_wrapper, script ]
    - !reference [ .update_trust_store, script ]

stages:
  - test
  - report_processing
  - publish
  - deploy
  - repo_management

workflow:
  rules:
    - if: '$SAFE_TEST =~ /true/i'
      variables:
        STANDARD_GRADLE_FLAGS: '$BASE_GRADLE_FLAGS -PsafeTest'
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: '$CI_COMMIT_BRANCH =~ $DEV_OR_RELEASE_REGEX'
    - if: $CI_PIPELINE_SOURCE == "web"
