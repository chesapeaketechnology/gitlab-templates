variables:
  JACOCO_HTML_LOCATION: ./reports/jacoco/index.html
  JACOCO_XML_LOCATION: ./reports/jacoco/jacoco-report.xml

test_java:
  stage: test
  script:
    - echo "Running tests with flags '$GRADLE_TEST_FLAGS'"
    - echo "CI_COMMIT_TAG = '$CI_COMMIT_TAG'"
    - ./gradlew test $GRADLE_TEST_FLAGS
  artifacts:
    when: always
    paths:
      - $JACOCO_HTML_LOCATION
      - $JACOCO_XML_LOCATION
    reports:
      junit:
        - "/build/test-results/test/**/TEST-*.xml"
        - "*/build/test-results/test/**/TEST-*.xml"
    expire_in: 1 days
  rules:
    # Don't rebuild when tags are committed
    - if: $TEST_JAVA_DISABLED
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"

visualize_test_coverage:
  stage: report_processing
  image: registry.gitlab.com/haynes/jacoco2cobertura:1.0.7
  script:
    - echo $JACOCO_XML_LOCATION
    - echo $JACOCO_HTML_LOCATION
    # GitLab CI "exist" rule doesn't account for artifacts so we need to check manually
    - test -e $JACOCO_XML_LOCATION || exit
    - test -e $JACOCO_HTML_LOCATION || exit
    - python /opt/cover2cover.py $JACOCO_XML_LOCATION src/main/java > $JACOCO_XML_LOCATION
    - python /opt/source2filename.py $JACOCO_XML_LOCATION
    - cat $JACOCO_HTML_LOCATION | grep -o 'Total[^%]*%'
  coverage: '/Total.*?([0-9]{1,3})%/'
  needs: [ "test_java" ]
  dependencies:
    - test_java
  artifacts:
    reports:
      cobertura: ./reports/jacoco/cobertura.xml
  rules:
    - if: $TEST_JAVA_DISABLED
      when: never
    - if: $VISUALIZE_TEST_COVERAGE_DISABLED
      when: never
    # Don't rebuild when tags are committed
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"